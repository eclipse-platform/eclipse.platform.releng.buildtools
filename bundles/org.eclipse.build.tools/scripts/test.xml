<project name="Targets to run Automated Tests Locally and Remotely" default="main" basedir=".">

<property name="customTest" value="${tester}/customTest.xml" />
<property name="testing.properties" value="${tester}/testing.properties" />
<property file="${testing.properties}" />

<target name="main">
	<antcall target="${testTarget}" />
</target>

<!--
Targets for setting up and running tests remotely
It is assumed that keys are set up on test machines to permit connections without user name and password prompts.
-->
<target name="runtests-remote" depends="setRemoteLoginClient,setRemoteCopyClient">
	<exec dir="." executable="${loginClient}">
		<arg line="${testMachine} mkdir ${testDir}" />
	</exec>
	
	<!--install the vm used for testing-->
	<antcall target="installVmForRemote" />
	
	<!--set up the automated testing framework-->
	<exec dir="." executable="${copyClient}">
		<arg line="${buildDirectory}/${buildLabel}/${testFramework} ${testMachine}:${testDir}" />
	</exec>
	<exec dir="." executable="${loginClient}">
		<arg line="${testMachine} unzip -o -qq ${testDir}/${testFramework} -d ${testDir}" />
	</exec>
	<exec dir="." executable="${copyClient}">
		<arg line="${buildDirectory}/${buildLabel}/${runtime} ${testMachine}:${testDir}/${executionDir}" />
	</exec>
	
	<!--callback to custom script for post setup-->
	<ant antfile="${customTest}" target="customSetup" dir="${basedir}" />
	
	<exec dir="." executable="${loginClient}">
		<arg line="${testMachine} ${testScript} ${args}" />
	</exec>
	
	<!--  this directory must exist before remote copy operation  -->
	<mkdir dir="${buildDirectory}/${buildLabel}/testresults" />
	<mkdir dir="${buildDirectory}/${buildLabel}/testresults/consolelogs" />
	
	<exec dir="." executable="${copyClient}">
		<arg line="-r ${testMachine}:${executionDir}/results/html ${buildDirectory}/${buildLabel}/testresults"/>
	</exec>
	<exec dir="." executable="${copyClient}">
		<arg line="-r ${testMachine}:${executionDir}/results/xml ${buildDirectory}/${buildLabel}/testresults"/>
	</exec>
	<exec dir="." executable="${copyClient}">
		<arg line="-r ${testMachine}:${executionDir}/results/chkpii ${buildDirectory}/${buildLabel}/testresults"/>
	</exec>

	<!--  copy the console log from testing  -->
	<exec dir="." executable="${copyClient}">
		<arg line="-r ${testMachine}:${executionDir}/${consolelog} ${buildDirectory}/${buildLabel}/testresults/consolelogs"/>
	</exec>
	
</target>

<target name="setRemoteLoginClient">
	<!--use rsh if rsh is set, otherwise use default, ssh-->
	<condition property="loginClient" value="rsh">
		<isset property="rsh" />
	</condition>
	<!--default remote login client-->
	<property name="loginClient" value="ssh" />	
</target>

<target name="setRemoteCopyClient">
	<!--use rcp if rsh is set, otherwise use default, scp-->
	<condition property="copyClient" value="rcp">
		<isset property="rsh" />
	</condition>
	<!--default remote copy client-->
	<property name="copyClient" value="scp" />	
</target>

<target name="installVmForRemote" unless="skipVmInstall">
	<!--get and install the vm to test with-->
	<get src="${vmUrl}" dest="${vmDest}"/>
	
	<exec dir="." executable="${copyClient}">
		<arg line="${vmDest} ${testMachine}:${testDir}" />
	</exec>
	
	<exec dir="." executable="${loginClient}">
		<arg line="${testMachine} ${vmInstallCommand}" />
	</exec>
</target>


<!--

Targets for setting up and running tests locally

-->
<target name="runtests-local">
	<delete dir="${testDir}" quiet="true"/>
	<mkdir dir="${testDir}" />

	<!--set up testing directory-->
	<unzip src="${buildDirectory}/${buildLabel}/${testFramework}" dest="${testDir}" />
	
	<!--install the vm used for testing-->
	<antcall target="installVmForLocal" />
	
	<!--copy in the runtime to test-->
	<copy todir="${executionDir}" file="${buildDirectory}/${buildLabel}/${runtime}" />

	<!--callback to custom script for additional setup-->
	<ant antfile="${customTest}" target="customSetup" dir="${basedir}" />

	<!--run the tests-->
	<exec dir="${executionDir}" executable="${testExecutable}">
  		<arg line="${args}" />
	</exec>

	<mkdir dir="${buildDirectory}/${buildLabel}/testresults" />
	<mkdir dir="${buildDirectory}/${buildLabel}/testresults/consolelogs" />

	<copy todir="${buildDirectory}/${buildLabel}/testresults">
		<fileset dir="${executionDir}/results" />
	</copy>

	<copy todir="${buildDirectory}/${buildLabel}/testresults/consolelogs" file="${executionDir}/${consolelog}" />
</target>

<target name="installVmForLocal" unless="skipVmInstall">
	<get src="${vmUrl}" dest="${vmDest}" usetimestamp="true"/>
	<exec dir="${testDir}" executable="${vmInstallExecutable}">	
		<arg line="${vmInstallCommand}" />
	</exec>
</target>


</project>